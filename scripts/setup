#!/bin/bash -e

# Install brew dependencies.
install_brew() {
  echo "Running brew..."
  brew bundle --file=brew/Brewfile
}

# Install oh-my-zsh.
install_oh-my-zsh() {
  DIR="$HOME/.oh-my-zsh"
  if [ -d "$DIR" ]; then
    echo "Existing installation found in  ${DIR}...updating oh-my-zsh."
    $ZSH/tools/upgrade.sh
    return 0;
  else
    echo "Installing oh-my-zsh..."
    # Install oh-my-zsh.
    sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
    return 0;
  fi
}

# Install powerlevel10k.
install_powerlevel10k() {
  DIR="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/themes/powerlevel10k"
  if [ -d "$DIR" ]; then
    echo "Existing installation found in  ${DIR}...updating p10k via a git pull."
    git -C ${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/themes/powerlevel10k pull
    return 0;
  else
    echo "Installing powerlevel10k..."
    # Install powerlevel10k.
    git clone --depth=1 https://github.com/romkatv/powerlevel10k.git ${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/themes/powerlevel10k
    return 0;
  fi
}

# Setup rc files.
symlink_dotfiles() {
  echo "Symlinking dotfiles..."
  rcup -fvd packages | nl -bn
}

# Configure VS code fonts and extensions.
configure_vscode() {
  echo "Applying Cloud Genius VS Code style..."

  ln -sf "/Applications/Visual Studio Code.app/Contents/Resources/app/bin/code" /usr/local/bin/code
  code --install-extension ms-vscode-remote.remote-ssh
  code --install-extension eamodio.gitlens
  code --install-extension CrazyFluff.bettermaterialthemedarkerhighcontrast
  code --install-extension vangware.dark-plus-material
  code --install-extension PKief.material-icon-theme

  cd ~/Library/Fonts && {
    rm -rf MesloLGS*.ttf
    wget "https://cloudgeniuscode.s3-us-west-2.amazonaws.com/MesloLGS NF Regular.ttf"
    wget "https://cloudgeniuscode.s3-us-west-2.amazonaws.com/MesloLGS NF Italic.ttf"
    wget "https://cloudgeniuscode.s3-us-west-2.amazonaws.com/MesloLGS NF Bold.ttf"
    wget "https://cloudgeniuscode.s3-us-west-2.amazonaws.com/MesloLGS NF Bold Italic.ttf"
    cd -;
  }

  rm -rf settings.json
  curl -O https://s3-us-west-2.amazonaws.com/cloudgeniuscode/settings.json
  mv -f settings.json "$HOME/Library/Application Support/Code/User/"
}

# Configure macOS defaults.
configure_macos() {
  echo "Applying macOS defaults..."
  source macos/defaults
}

# Configure duti default file handlers.
configure_duti() {
  echo "Applying duti defaults..."

  # VS Code
  local vsCodeExtensions=(json md py sh yaml yml)
  for extension in "${vsCodeExtensions[@]}"
  do
    duti -s com.microsoft.VSCode .${extension} all
  done

  # The Unarchiver
  local unarchiverExtensions=(zip rar)
  for extension in "${unarchiverExtensions[@]}"
  do
    duti -s com.macpaw.site.theunarchiver .${extension} all
  done
}



install_brew
install_oh-my-zsh
install_powerlevel10k
symlink_dotfiles
configure_vscode
# configure_macos
configure_duti
